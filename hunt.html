<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>The Hunt</title>

  <!-- NES.css -->
  <link href="https://fonts.googleapis.com/css?family=Press+Start+2P" rel="stylesheet">
  <link href="https://unpkg.com/nes.css/css/nes.css" rel="stylesheet">

  <style>
    body {
      margin: 0;
      font-family: 'Press Start 2P', cursive;
      background: #212529;
      color: #fff;
    }

    .header {
      background: #2ed573;
      padding: 16px;
      text-align: center;
      border-bottom: 4px solid #000;
    }

    .content {
      padding: 24px 16px;
      min-height: calc(100vh - 80px);
      background: #3742fa;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

    h2 {
      font-size: 14px;
      margin-bottom: 12px;
    }

    p {
      font-size: 10px;
      line-height: 1.6;
      max-width: 320px;
    }

    .hint-box {
      margin: 20px 0;
      padding: 16px;
      background: #000;
      border: 4px solid #fff;
      width: 100%;
      max-width: 320px;
    }

    #reader {
      margin-top: 20px;
      width: 260px;
      display: none;
    }

    .timer-box {
      margin: 12px 0;
      padding: 12px;
      background: #000;
      border: 4px solid #fff;
      width: 100%;
      max-width: 200px;
      font-size: 12px;
    }
  </style>
</head>

<body>

  <!-- HEADER -->
  <div class="header">
    <h1 id="teamName">TEAM</h1>
  </div>

  <!-- CONTENT -->
  <div class="content">

    <h2>NEXT LOCATION</h2>

    <div class="timer-box nes-container is-rounded">
      <p id="timerText">20:00</p>
    </div>
    
    <div class="hint-box">
      <p id="hintText">Loading hint...</p>
    </div>

    <button class="nes-btn is-primary" onclick="startScan()">
      SCAN QR CODE
    </button>

    <div id="reader"></div>

  </div>

  <!-- QR SCANNER -->
  <script src="https://unpkg.com/html5-qrcode"></script>

  <!-- FIREBASE -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore,
      doc,
      getDoc,
      updateDoc,
      serverTimestamp,
      collection,
      getDocs,
      query,
      orderBy
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";


    // ðŸ”¥ YOUR FIREBASE CONFIG HERE
    const firebaseConfig = {
      apiKey: "AIzaSyA0P3c4ORJ2LseF32C8bIDiKakJVtrAaHw",
      authDomain: "makeaquest-11af6.firebaseapp.com",
      projectId: "makeaquest-11af6",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const huntId = localStorage.getItem("huntId");
    const teamCode = localStorage.getItem("teamCode");

    if (!huntId || !teamCode) {
      window.location.href = "setup.html";
    }

    const teamRef = doc(db, "hunts", huntId, "teams", teamCode);

    async function loadHunt() {
      // Load team
      const teamSnap = await getDoc(teamRef);
      if (!teamSnap.exists()) return;

      const team = teamSnap.data();
      document.getElementById("teamName").textContent = team.teamName;

      const teamSnap = await getDoc(teamRef);
      if (!teamSnap.exists()) return;
      
      const team = teamSnap.data();
      
      // Start countdown if startedAt exists
      if (team.startedAt) {
        startCountdown(team.startedAt);
      }

      const completed = team.progress
        ? Object.keys(team.progress)
        : [];

      // Load stops
      const stopsRef = collection(db, "hunts", huntId, "stops");
      const q = query(stopsRef, orderBy("order"));
      const stopSnaps = await getDocs(q);

      let nextStop = null;
      stopSnaps.forEach(doc => {
        if (!completed.includes(doc.id) && !nextStop) {
          nextStop = doc.data();
        }
      });

      if (nextStop) {
        document.getElementById("hintText").textContent = nextStop.hint;
      } else {
        document.getElementById("hintText").textContent =
          "YOU FOUND ALL LOCATIONS!";
      }
    }

    loadHunt();

      // QR Scanner
  let scanner;
    
    window.startScan = function () {
      const reader = document.getElementById("reader");
      reader.style.display = "block";
    
      scanner = new Html5Qrcode("reader");
      
      // Synchronous callback
      const onScanSuccess = (scannedText) => {
        // Stop scanner immediately
        scanner.stop().then(() => {
          reader.style.display = "none";
          handleScan(scannedText); // handle async separately
        }).catch(err => {
          console.error("Failed to stop scanner:", err);
        });
      };
    
      scanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        onScanSuccess
      );
    };
    
    // Separate async function for Firestore operations
    async function handleScan(scannedText) {
      console.log("Scanned QR:", scannedText);
      const stopId = scannedText.trim();
    
      const stopRef = doc(db, "hunts", huntId, "stops", stopId);
      const stopSnap = await getDoc(stopRef);
    
      console.log("stopSnap exists?", stopSnap.exists());
    
      if (!stopSnap.exists()) {
        alert("Invalid QR code! (" + stopId + ")");
        return;
      }
    
      // Load current team data
      const teamSnap = await getDoc(teamRef);
      const teamData = teamSnap.data();
      const progress = teamData.progress || {};
    
      if (progress[stopId]) {
        alert("You already found this stop!");
      } else {
        // Mark stop as completed
        await updateDoc(teamRef, {
          [`progress.${stopId}`]: serverTimestamp()
        });
    
        alert(`Stop unlocked: ${stopSnap.data().name}!`);
    
        // Reload next hint
        loadHunt();
      }
    }
    
    
    // Set total game duration in minutes
    const GAME_DURATION_MINUTES = 20;
    
    function startCountdown(startedAt) {
      const timerText = document.getElementById("timerText");
    
      function updateTimer() {
        const now = new Date();
        const startTime = startedAt.toDate(); // Firestore Timestamp â†’ JS Date
        const endTime = new Date(startTime.getTime() + GAME_DURATION_MINUTES * 60 * 1000);
    
        let remaining = Math.max(0, endTime - now); // milliseconds
    
        const minutes = Math.floor(remaining / 60000);
        const seconds = Math.floor((remaining % 60000) / 1000);
    
        timerText.textContent = `${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
    
        if (remaining <= 0) {
          clearInterval(timerInterval);
          alert("Time's up!"); // Or show NES-style modal
        }
      }
    
      updateTimer(); // initial call
      const timerInterval = setInterval(updateTimer, 1000);
    }


  </script>

</body>
</html>
